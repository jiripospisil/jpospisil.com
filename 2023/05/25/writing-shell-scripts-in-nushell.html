<!DOCTYPE html>
<html>
    <head>
        
        <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="preload" crossorigin="anonymous" href="/css/default.css" as="style">
<link rel="preload" crossorigin="anonymous" href="/css/post.css" as="style">

<link rel="stylesheet" crossorigin="anonymous" href="/css/post.css">
<link rel="icon" crossorigin="anonymous" href="/images/favicon.png">
<title>
            Writing shell scripts in Nushell - Jiri Pospisil
        </title>

    </head>

    <body>
        <div class="container">
            <h1><a href="/2023/05/25/writing-shell-scripts-in-nushell.html">Writing shell scripts in Nushell</a></h1>

            <div class="topbar">
                <a href="/"><img class="logo" height="30px" src="/images/logo.jpg"></a>
                <div class="name"><a href="/">Jiri Pospisil</a></div>
    			<span class="published">Published May 25, 2023</span>
            </div>

            <p>I don’t like Bash. It’s just too confusing. Do I need to use double brackets
for this? Do I need to quote this? Am I still writing <a href="https://en.wikipedia.org/wiki/Bash_(Unix_shell)">Bash</a> or am I sprinkling in
some bits of <a href="https://en.wikipedia.org/wiki/Bourne_shell">sh</a>? I can never remember.</p>
<pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#62a35c;">[ </span><span style="color:#323232;">-n $var </span><span style="color:#62a35c;">]   </span><span style="font-style:italic;color:#969896;"># All sorts of wrong
</span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#62a35c;">[ </span><span style="color:#323232;">-n </span><span style="color:#183691;">&quot;$</span><span style="color:#323232;">var</span><span style="color:#183691;">&quot; </span><span style="color:#62a35c;">] </span><span style="font-style:italic;color:#969896;"># POSIX
</span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#62a35c;">[[ </span><span style="color:#323232;">-n $var </span><span style="color:#62a35c;">]] </span><span style="font-style:italic;color:#969896;"># Bash
</span></code></pre>
<p><em>Tip: If you are stuck writing Bash scripts, use <a href="https://www.shellcheck.net">ShellCheck</a> to check it for bugs.</em></p>
<p>At the same time I keep finding myself writing shell scripts because sometimes
it’s just so damn convenient. Sure, I could use a <em>real</em> programming language but
it gets annoying pretty quickly when the script is really just driving external
commands.</p>
<p>Let's try using <a href="https://www.nushell.sh">Nushell</a>. I will let you peruse their website on your own but
the key takeaways are that Nushell is a modern alternative that tries to avoid
many of the pitfalls of Bash (and other shells) and to provide a sane scripting
environment.</p>
<div class="image">
  <img src="/posts/nushell/1.png" title="57MB? Outrages! In all seriousness, it should consume less.">
</div>
<p>You will also notice that in Nushell you work with structured data. Each of the
commands understands what’s being passed in. That's probably a bit controversial
among UNIX enthusiasts who prefer using plain text but honestly I don't really
mind. Reminds me of <a href="https://github.com/PowerShell/PowerShell">PowerShell</a>.</p>
<p>Of course the same thing could be achieved in other shells but it’s often either
more involved or hard to remember.</p>
<pre style="background-color:#ffffff;">
<code><span style="font-style:italic;color:#969896;"># Bash / Zsh
</span><span style="color:#323232;">find . -maxdepth 1 -type f -size +10M -exec ls -lh --sort</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#323232;">time -r {} +
</span><span style="color:#323232;">
</span><span style="font-style:italic;color:#969896;"># Zsh
</span><span style="color:#323232;">ls -lh </span><span style="font-weight:bold;color:#a71d5d;">*</span><span style="color:#323232;">(Lm+10om) --sort</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#323232;">time -r
</span></code></pre>
<p><em>Tip: Have a look at <a href="https://thevaluable.dev/zsh-expansion-guide-example">A Guide to Zsh Expansion with Examples</a> for more Zsh wizardry.</em></p>
<p>Using Nushell as an actual terminal shell is all good and well but I think a
more interesting use case is to use it to write scripts.</p>
<p>As an exercise, let’s write a script that will sum all the numbers passed in as
arguments. Nushell scripts are executed top to bottom as any other scripts, but
to get access to command line arguments, we do need to define a main function.</p>
<pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">def </span><span style="font-weight:bold;color:#795da3;">main </span><span style="color:#323232;">[...numbers] {
</span><span style="color:#323232;">  </span><span style="font-style:italic;color:#969896;"># 1.
</span><span style="color:#323232;">  </span><span style="color:#62a35c;">mut </span><span style="color:#323232;">total </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">0
</span><span style="color:#323232;">  
</span><span style="color:#323232;">  </span><span style="font-weight:bold;color:#a71d5d;">for </span><span style="color:#323232;">number in $numbers {
</span><span style="color:#323232;">    $total </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#323232;">($number </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#62a35c;">into </span><span style="color:#323232;">int)
</span><span style="color:#323232;">  }
</span><span style="color:#323232;">
</span><span style="color:#323232;">  </span><span style="color:#62a35c;">print</span><span style="color:#323232;"> $total
</span><span style="color:#323232;">
</span><span style="color:#323232;">  </span><span style="font-style:italic;color:#969896;"># 2.
</span><span style="color:#323232;">  </span><span style="color:#62a35c;">print </span><span style="color:#323232;">($numbers </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#62a35c;">reduce </span><span style="color:#323232;">{ </span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#323232;">it, acc</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#323232;"> $it </span><span style="font-weight:bold;color:#a71d5d;">+</span><span style="color:#323232;"> $acc })
</span><span style="color:#323232;">
</span><span style="color:#323232;">  </span><span style="font-style:italic;color:#969896;"># 3.
</span><span style="color:#323232;">  </span><span style="color:#62a35c;">print </span><span style="color:#323232;">($numbers </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#62a35c;">math </span><span style="color:#323232;">sum)
</span><span style="color:#323232;">}
</span></code></pre>
<pre style="background-color:#ffffff;">
<code><span style="color:#323232;">./sum.nu 1 2 3
</span><span style="color:#323232;">6
</span><span style="color:#323232;">6
</span><span style="color:#323232;">6
</span></code></pre>
<p>Passing in a string instead of a number will make the script rightfully angry.
We can do better and declare that we want accept integers only.</p>
<pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">def </span><span style="font-weight:bold;color:#795da3;">main </span><span style="color:#323232;">[...numbers: int]
</span></code></pre>
<p>The difference is that now the body of the function will not get to run and
we get a nice error message. Imagine a wild project manager comes in and says
we need to accept a flag which will determine whether to sum or multiply the
numbers.</p>
<pre style="background-color:#ffffff;">
<code><span style="font-style:italic;color:#969896;"># A command to work on numbers
</span><span style="font-weight:bold;color:#a71d5d;">def </span><span style="font-weight:bold;color:#795da3;">main </span><span style="color:#323232;">[
</span><span style="color:#323232;">  ...numbers</span><span style="font-weight:bold;color:#a71d5d;">: </span><span style="color:#323232;">int, </span><span style="font-style:italic;color:#969896;"># Numbers to work on
</span><span style="color:#323232;">  </span><span style="font-weight:bold;color:#a71d5d;">--</span><span style="color:#323232;">multiply (</span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#323232;">m)  </span><span style="font-style:italic;color:#969896;"># Operation to perform
</span><span style="color:#323232;">  ] {
</span><span style="color:#323232;">    </span><span style="color:#62a35c;">if </span><span style="color:#323232;">($numbers </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#323232;">is</span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#62a35c;">empty</span><span style="color:#323232;">) {
</span><span style="color:#323232;">      </span><span style="color:#62a35c;">help </span><span style="color:#323232;">main </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#62a35c;">print </span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#323232;">e
</span><span style="color:#323232;">      </span><span style="color:#62a35c;">exit </span><span style="color:#0086b3;">1
</span><span style="color:#323232;">    }
</span><span style="color:#323232;">
</span><span style="color:#323232;">    </span><span style="color:#62a35c;">if</span><span style="color:#323232;"> $multiply {
</span><span style="color:#323232;">      </span><span style="color:#62a35c;">print </span><span style="color:#323232;">($numbers </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#62a35c;">math </span><span style="color:#323232;">mul)
</span><span style="color:#323232;">    } else {
</span><span style="color:#323232;">      </span><span style="color:#62a35c;">print </span><span style="color:#323232;">($numbers </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#62a35c;">math </span><span style="color:#323232;">sum)
</span><span style="color:#323232;">    }
</span><span style="color:#323232;">}
</span></code></pre>
<pre style="background-color:#ffffff;">
<code><span style="color:#323232;">./sum.nu 1 2 3 4 --multiply # or -m
</span><span style="color:#323232;">24
</span><span style="color:#323232;">./sum.nu 1 2 3 4
</span><span style="color:#323232;">10
</span></code></pre>
<p>Notice that the flag doesn't have a type. In this case, Nushell takes the
presence or absence of the flag as the bool value. If we had specified an
explicit bool type, we would have to pass in a value on the command line e.g.
“-m true”.</p>
<p>The comments next to the function’s arguments are used for the auto-generated
documentation. Notice that we can print the documentation programmatically to
show “usage” in case we get an invalid input.</p>
<pre style="background-color:#ffffff;">
<code><span style="color:#323232;">./sum.nu --help
</span><span style="color:#323232;">A command to work on numbers
</span><span style="color:#323232;">
</span><span style="color:#323232;">Usage:
</span><span style="color:#323232;">  &gt; main {flags} ...(numbers) 
</span><span style="color:#323232;">
</span><span style="color:#323232;">Flags:
</span><span style="color:#323232;">  -m, --multiply - Operation to perform
</span><span style="color:#323232;">  -h, --help - Display the help message for this command
</span><span style="color:#323232;">
</span><span style="color:#323232;">Parameters:
</span><span style="color:#323232;">  ...numbers &lt;int&gt;: Numbers to work on 
</span></code></pre>
<p>The sub-command &quot;mul” actually doesn't exist in the <a href="https://www.nushell.sh/commands">standard library</a> but we can add it a basic version of it.</p>
<pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">def</span><span style="color:#323232;"> &quot;</span><span style="font-weight:bold;color:#795da3;">math mul</span><span style="color:#323232;">&quot; [] {
</span><span style="color:#323232;">  $in </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#62a35c;">reduce </span><span style="color:#323232;">{ </span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#323232;">it, acc</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#323232;"> $it </span><span style="font-weight:bold;color:#a71d5d;">*</span><span style="color:#323232;"> $acc }
</span><span style="color:#323232;">}
</span></code></pre>
<p>Okay, so it’s very easy to accept command line arguments and flags. What about
running some external programs? After all, all we've done so far is stay within
the Nushell’s runtime.</p>
<p>Let’s write a script which will return two of the latest commits for a given
GitHub repository using curl and <a href="https://stedolan.github.io/jq">jq</a>.</p>
<pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">def </span><span style="font-weight:bold;color:#795da3;">main </span><span style="color:#323232;">[
</span><span style="color:#323232;">  name</span><span style="font-weight:bold;color:#a71d5d;">: </span><span style="color:#323232;">string </span><span style="font-style:italic;color:#969896;"># Format: username/repository
</span><span style="color:#323232;">  ] {
</span><span style="color:#323232;">    </span><span style="color:#62a35c;">if</span><span style="color:#323232;"> $name </span><span style="font-weight:bold;color:#a71d5d;">!</span><span style="color:#183691;">~ \A[a-zA-Z0-9-_.]+/[a-zA-Z0-9-_.]+\z {
</span><span style="color:#323232;">      </span><span style="color:#62a35c;">help </span><span style="color:#323232;">main </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#62a35c;">print </span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#323232;">e
</span><span style="color:#323232;">      </span><span style="color:#62a35c;">exit </span><span style="color:#0086b3;">1
</span><span style="color:#323232;">    }
</span><span style="color:#323232;">
</span><span style="color:#323232;">    </span><span style="color:#62a35c;">let </span><span style="color:#323232;">url </span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#323232;"> $</span><span style="color:#183691;">&quot;https://api.github.com/repos/($name)/commits&quot;
</span><span style="color:#323232;">
</span><span style="color:#323232;">    curl </span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#323232;">s $</span><span style="color:#62a35c;">url
</span><span style="color:#323232;">      </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#323232;">jq </span><span style="color:#183691;">&#39;[.[] | { author: .commit.author.name, msg: .commit.message[:20] }][:2]&#39;
</span><span style="color:#323232;">      </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#62a35c;">from </span><span style="color:#323232;">json 
</span><span style="color:#323232;">}
</span></code></pre>
<p>The meat of the script is not very different from what we would write in Bash.</p>
<pre style="background-color:#ffffff;">
<code><span style="color:#323232;">./git.nu nushell/nushell
</span></code></pre>
<div class="image">
  <img src="/posts/nushell/2.png">
</div>
<p>What happens if we pass in a project name which doesn't exist?</p>
<pre style="background-color:#ffffff;">
<code><span style="color:#323232;">./git.nu nushell/nushell2
</span><span style="color:#323232;">jq: error (at &lt;stdin&gt;:4): Cannot index string with string &quot;commit&quot;
</span></code></pre>
<p>Well, that’s not great. The problem is that the request technically succeeded
but returned HTTP 404. We can tell curl to return a non-zero exit code in case
of server errors and to not output anything.</p>
<pre style="background-color:#ffffff;">
<code><span style="color:#323232;">curl --fail -s $url | jq ...
</span></code></pre>
<p>Alright, now curl returns exit code 22 on any HTTP error and doesn't pass any
data forward which in turn makes jq output nothing.</p>
<pre style="background-color:#ffffff;">
<code><span style="color:#323232;">./git.nu nushell/nushell2
</span></code></pre>
<p>But what if we wanted to write a message informing the user that the repository
was not found? We can use <a href="https://www.nushell.sh/commands/docs/complete.html">complete</a> to capture the output and exit code.</p>
<pre style="background-color:#ffffff;">
<code><span style="color:#62a35c;">let </span><span style="color:#323232;">response </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">(curl </span><span style="font-weight:bold;color:#a71d5d;">--</span><span style="color:#323232;">fail </span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#323232;">s $</span><span style="color:#62a35c;">url </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#62a35c;">complete</span><span style="color:#323232;">)
</span><span style="color:#323232;">
</span><span style="color:#62a35c;">match</span><span style="color:#323232;"> $response.exit_code {
</span><span style="color:#323232;">  </span><span style="color:#0086b3;">0 </span><span style="font-weight:bold;color:#a71d5d;">=&gt; </span><span style="color:#323232;">{
</span><span style="color:#323232;">    $response.stdout </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#323232;">jq ...
</span><span style="color:#323232;">  },
</span><span style="color:#323232;">  </span><span style="color:#0086b3;">22 </span><span style="font-weight:bold;color:#a71d5d;">=&gt; </span><span style="color:#323232;">{
</span><span style="color:#323232;">    </span><span style="color:#62a35c;">print </span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#323232;">e $</span><span style="color:#183691;">&quot;Project \&quot;</span><span style="color:#323232;">($name)</span><span style="font-weight:bold;color:#a71d5d;">\</span><span style="color:#183691;">&quot; not found or server error!&quot;
</span><span style="color:#323232;">    </span><span style="color:#62a35c;">exit </span><span style="color:#0086b3;">1
</span><span style="color:#323232;">  },
</span><span style="color:#323232;">  </span><span style="font-weight:bold;color:#a71d5d;">- =&gt; </span><span style="color:#323232;">{
</span><span style="color:#323232;">    </span><span style="color:#62a35c;">print </span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#323232;">e </span><span style="color:#183691;">&quot;It&#39;s all broken.&quot;
</span><span style="color:#323232;">    </span><span style="color:#62a35c;">exit </span><span style="color:#0086b3;">1
</span><span style="color:#323232;">  }
</span><span style="color:#323232;">}
</span></code></pre>
<pre style="background-color:#ffffff;">
<code><span style="color:#323232;">./git.nu nushell/nushell2
</span><span style="color:#323232;">Project &quot;nushell/nushell2&quot; not found!
</span></code></pre>
<p>Alright, we can invoke external commands, capture the exit code and the output.
Not everything is hunky-dory however. In Bash, it’s good hygiene to always start
your scripts with a set command to make it behave in a sane-er manner.</p>
<pre style="background-color:#ffffff;">
<code><span style="color:#323232;">set -eu -o pipefail
</span></code></pre>
<p>This tells Bash to exit on any non-zero exit code, undefined variables, and use
the last non-zero exit code in a pipe as the exit code of the whole pipe.</p>
<p>The internet is full of discussions on whether these options make things better
or worse, but it’s worth noting that while Nushell will report usage of any
undefined variables (and missing external commands!), exit on error, it will NOT
propagate the pipe error when using external commands.</p>
<pre style="background-color:#ffffff;">
<code><span style="color:#323232;">cat missing | wc -c
</span><span style="color:#323232;">print &quot;Hm!&quot;
</span></code></pre>
<pre style="background-color:#ffffff;">
<code><span style="color:#323232;">./pipe.nu  
</span><span style="color:#323232;">cat: missing: No such file or directory
</span><span style="color:#323232;">0
</span><span style="color:#323232;">Hm!
</span></code></pre>
<p>The cat command fails, the wc command succeeds but doesn't receive any data. And
crucially, the next line is still executed. The default behavior in Bash is the
same but we can change it.</p>
<pre style="background-color:#ffffff;">
<code><span style="color:#323232;">set -eu -o pipefail
</span><span style="color:#323232;">
</span><span style="color:#323232;">cat missing | wc -c
</span><span style="color:#323232;">echo &quot;Hm!&quot;
</span></code></pre>
<pre style="background-color:#ffffff;">
<code><span style="color:#323232;">./pipe.bash 
</span><span style="color:#323232;">cat: missing: No such file or directory
</span><span style="color:#323232;">0
</span></code></pre>
<p>What if we wanted a similar behavior in Nushell? We can achieve it using the
<a href="https://www.nushell.sh/commands/docs/do.html">do</a> command, albeit it makes working with external commands a bit awkward.
Commands wrapped in <em>do -c</em> are eagerly evaluated and the entire pipeline is
canceled. The wc commands doesn't get to run at all.</p>
<pre style="background-color:#ffffff;">
<code><span style="color:#323232;">do -c { cat missing } | wc -c
</span><span style="color:#323232;">print &quot;Hm!&quot;
</span></code></pre>
<div class="image">
  <img src="/posts/nushell/3.png">
</div>
<p>Unfortunately, we cannot wrap the whole pipeline in a do, we would have to do it
individually for every external command in the pipeline.</p>
<p><em>Note that handling of external commands is still work in progress and it’s very
likely to change in the future.</em></p>
<p>While we’re at it, you might be wondering why dealing with exit codes is even a
thing. After all, exit code 0 indicates success, otherwise it’s an error. Right?
Unfortunately, there’s a lot of commands which <a href="https://www.jntrnr.com/exit-codes">do not follow these rules</a>. Take
diff for example.</p>
<blockquote>
<p>Exit code is 0 if inputs are the same, 1 if different, 2 if trouble.</p>
</blockquote>
<p>No matter how shells deal with exit codes of external commands, there will
eventually be a situation where the default behavior is not what you want. Oh
well.</p>
<p>Let’s get back to our little Git example. The script uses external commands to
do the heavy lifting of interacting with the network and parsing of the result.
While it works and is probably one of the ways one would do it in Bash, it
certainly isn't the “go-to” solution in Nushell.</p>
<p>Nushell has a fairly rich (and ever expanding) <a href="https://www.nushell.sh/commands">standard library</a> for dealing with
the most common problems. Let’s try to rewrite the example using just Nushell’s
built-in <a href="https://www.nushell.sh/commands/categories/network.html">Network</a> commands.</p>
<p>Instead of using curl, we can use the built-in <a href="https://www.nushell.sh/commands/docs/http_get.html">http get</a> command. This of course
doesn't support all of the curl’s hundreds of options and features, but our use
case is really trivial.</p>
<pre style="background-color:#ffffff;">
<code><span style="color:#62a35c;">let </span><span style="color:#323232;">response </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">(http </span><span style="color:#62a35c;">get </span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#323232;">f </span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#323232;">e $</span><span style="color:#62a35c;">url</span><span style="color:#323232;">)
</span><span style="color:#323232;">
</span><span style="color:#62a35c;">match</span><span style="color:#323232;"> $response.status {
</span><span style="color:#323232;">  </span><span style="color:#0086b3;">200 </span><span style="font-weight:bold;color:#a71d5d;">=&gt; </span><span style="color:#323232;">{
</span><span style="color:#323232;">    $response.body
</span><span style="color:#323232;">      </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#62a35c;">select </span><span style="color:#323232;">commit 
</span><span style="color:#323232;">      </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#62a35c;">take </span><span style="color:#0086b3;">2
</span><span style="color:#323232;">      </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#62a35c;">each </span><span style="color:#323232;">{ </span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#323232;">it</span><span style="font-weight:bold;color:#a71d5d;">| 
</span><span style="color:#323232;">        { 
</span><span style="color:#323232;">          author</span><span style="font-weight:bold;color:#a71d5d;">:</span><span style="color:#323232;"> $it.commit.author.name 
</span><span style="color:#323232;">          msg</span><span style="font-weight:bold;color:#a71d5d;">: </span><span style="color:#323232;">($it.commit.message </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#62a35c;">str </span><span style="color:#323232;">substring </span><span style="color:#0086b3;">0..20</span><span style="color:#323232;">)
</span><span style="color:#323232;">        }
</span><span style="color:#323232;">      }
</span><span style="color:#323232;">  },
</span><span style="color:#323232;">  </span><span style="color:#0086b3;">404 </span><span style="font-weight:bold;color:#a71d5d;">=&gt; </span><span style="color:#323232;">{ ... },
</span><span style="color:#323232;">  _ </span><span style="font-weight:bold;color:#a71d5d;">=&gt; </span><span style="color:#323232;">{ ... }
</span><span style="color:#323232;">}
</span></code></pre>
<p>The output is exactly the same table as before. Besides the networking support,
we’re also taking advantage of Nushell’s ability to filter and reach into tables
and records.</p>
<p>This code also handles errors better. Those pipes run entirely within the
runtime using the built-in commands which means we don’t have to worry about
exit codes and command termination.</p>
<p>If we didn't want to provide a different message based on the HTTP status, we
could take advantage of <a href="https://www.nushell.sh/commands/docs/try.html">try/catch</a> to simply the code even further. It’s worth
noting that this mechanism seems to work as expected for built-in commands only.</p>
<pre style="background-color:#ffffff;">
<code><span style="color:#62a35c;">try </span><span style="color:#323232;">{
</span><span style="color:#323232;">  ...
</span><span style="color:#323232;">} </span><span style="color:#62a35c;">catch </span><span style="color:#323232;">{ </span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#323232;">e</span><span style="font-weight:bold;color:#a71d5d;">|
</span><span style="color:#323232;">  </span><span style="color:#62a35c;">print </span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#323232;">e $</span><span style="color:#183691;">&quot;An error occurred! ($e)&quot;
</span><span style="color:#323232;">}
</span></code></pre>
<p>In fact, since we’re just adding a prefix to the error message, we can take get
rid of the error handling all together and let the code fail.</p>
<pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">def </span><span style="font-weight:bold;color:#795da3;">main </span><span style="color:#323232;">[
</span><span style="color:#323232;">  name</span><span style="font-weight:bold;color:#a71d5d;">: </span><span style="color:#323232;">string </span><span style="font-style:italic;color:#969896;"># Format: username/repository
</span><span style="color:#323232;">  ] {
</span><span style="color:#323232;">    </span><span style="color:#62a35c;">if</span><span style="color:#323232;"> $name </span><span style="font-weight:bold;color:#a71d5d;">!</span><span style="color:#183691;">~ \A[a-zA-Z0-9-_.]+/[a-zA-Z0-9-_.]+\z {
</span><span style="color:#323232;">      </span><span style="color:#62a35c;">help </span><span style="color:#323232;">main </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#62a35c;">print </span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#323232;">e
</span><span style="color:#323232;">      </span><span style="color:#62a35c;">exit </span><span style="color:#0086b3;">1
</span><span style="color:#323232;">    }
</span><span style="color:#323232;">
</span><span style="color:#323232;">    </span><span style="color:#62a35c;">let </span><span style="color:#323232;">url </span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#323232;"> $</span><span style="color:#183691;">&quot;https://api.github.com/repos/($name)/commits&quot;
</span><span style="color:#323232;">
</span><span style="color:#323232;">    http </span><span style="color:#62a35c;">get</span><span style="color:#323232;"> $</span><span style="color:#62a35c;">url 
</span><span style="color:#323232;">      </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#62a35c;">select </span><span style="color:#323232;">commit 
</span><span style="color:#323232;">      </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#62a35c;">take </span><span style="color:#0086b3;">2
</span><span style="color:#323232;">      </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#62a35c;">each </span><span style="color:#323232;">{ </span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#323232;">it</span><span style="font-weight:bold;color:#a71d5d;">| 
</span><span style="color:#323232;">          { 
</span><span style="color:#323232;">            author</span><span style="font-weight:bold;color:#a71d5d;">:</span><span style="color:#323232;"> $it.commit.author.name 
</span><span style="color:#323232;">            msg</span><span style="font-weight:bold;color:#a71d5d;">: </span><span style="color:#323232;">($it.commit.message </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#62a35c;">str </span><span style="color:#323232;">substring </span><span style="color:#0086b3;">0..20</span><span style="color:#323232;">)
</span><span style="color:#323232;">          }
</span><span style="color:#323232;">        }
</span><span style="color:#323232;">}
</span></code></pre>
<p>In fact, in this case, we get a much better error message without the explicit
error handling that’s even pointing to the problem and prints context. Nice.</p>
<div class="image">
  <img src="/posts/nushell/4.png">
</div>
<p>Alright, that’s a long enough introduction. Going forward, I think I've
convinced myself to try creating scripts in Nushell first and only fallback to
alternatives in case of trouble. Let’s mention a few disadvantages to close off.</p>
<p>First, Nushell is a new shell and a scripting language that’s intentionally not
backwards compatible with other shells. This means learning a completely new
environment and all its quirks and features.</p>
<p>Second, Nushell has not reached a v1.0 (currently at v0.80). This means things
are still evolving and releases sometimes come with a few breaking changes,
potentially breaking your existing scripts. You might want to wait for things to
settle down.</p>
<p>Third, there’s a pretty good chance that everybody has Bash installed on their
system (let’s pretend Windows doesn't exist). Not so much with Nushell. It has
made its way to almost every distribution’s package manager out there (<a href="https://knowyourmeme.com/memes/btw-i-use-arch">I use
Arch btw</a>) but depending on your circumstances you might be out of luck.</p>
<p>The good news here however is that if you do have it available and stay
within the standard library, your scripts should work on all Nushell supported
platforms out of the box.</p>
<div class="image">
  <img src="/posts/nushell/5.png">
</div>


            <p class="back"><a href="/">Go back to the front page</a></p>
        </div>
  </body>
</html>
