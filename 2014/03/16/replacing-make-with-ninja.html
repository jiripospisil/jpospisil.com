<!DOCTYPE html><html><head><title>Replacing Make with Ninja - Jiri Pospisil's blog</title><meta charset=utf-8 /><meta content="width=device-width, initial-scale=1" name=viewport /><link href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/css/bootstrap.min.css" rel=stylesheet /><link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.min.css" rel=stylesheet /><link href="/stylesheets/application-2bb2f56f.css" rel=stylesheet /><link href="/images/favicon.ico" rel="shortcut icon" type="image/vnd.microsoft.icon"/><link href="/feed.xml" rel=alternate title="Jiri Pospisil's blog - Atom Feed" type="application/atom+xml"/></head><body><div class=container><div class=row><div class=col-sm-3><div class=hidden-xs><div class=avatar><a href="/"><img height=150px src="/images/avatar-c0869a08.jpg" width=150px /></a></div><div class=personal-info><h3>Jiří Pospíšil</h3><div class=icons><a href="https://github.com/mekishizufu"><i class="fa fa-github"></i></a><a href="https://twitter.com/JiriPospisil"><i class="fa fa-twitter"></i></a><a href="//stackoverflow.com/users/19093/jiri-pospisil"><i class="fa fa-stack-overflow"></i></a><a href="//jpospisil.com/feed.xml"><i class="fa fa-rss-square"></i></a></div><p>I'm a full stack developer currently working primarily with Ruby on Rails and Ember.js.</p><p>I live in the Czech Republic, love reading and learning new things. I'm very passionate about technologies and computing in general.</p><p>You can get in touch with me at <a href="mailto:mekishizufu@gmail.com">mekishizufu@gmail.com</a></p></div><div class=articles-info><h5>Recent articles</h5><ul><li><a href="/2014/03/16/replacing-make-with-ninja.html">Replacing Make with Ninja</a></li></ul><h5>Archives</h5><ul><li><a href="/2014.html">2014 (1)</a></li></ul></div></div></div><div class=col-sm-9><div class=visible-xs><p>Written by <strong>Jiří Pospíšil</strong>, a full stack developer currently working primarily with Ruby on Rails and Ember.js.</p><p>You can get in touch with me at <a href="mailto:mekishizufu@gmail.com">mekishizufu@gmail.com</a></p><hr/></div><h1><a href="/2014/03/16/replacing-make-with-ninja.html">Replacing Make with Ninja</a></h1><div class=published>Published on Mar 16, 2014</div><p>Make and all of its flavours have been here for almost 40 years and it&rsquo;s a tool hard to beat for many things. There are however cases when you do not need the power of Make and are willing to trade the flexibility for something else. In case of <a href="//martine.github.io/ninja">Ninja</a>, for its speed.</p> <p>Speed is the main motivation behind Ninja and its decisions how to write your build files. Ninja was written by <a href="//neugierig.org">Evan Martin</a> specifically to fight slow build cycles while working on Google Chrome. </p> <p>The bigger the project, the longer it takes to figure out what files need to be recompiled or if any action is required at all. As a result of numerous optimizations, Ninja is much faster when compared to alternatives. Ninja&rsquo;s secret is to do the least amount of work possible and let other more high level tools to handle the rest upfront. </p> <p>Let&rsquo;s see an example of a simple script featuring all of the abstractions Ninja provides:</p> <pre class="highlight shell"><span class="c"># build.ninja</span>
cc     <span class="o">=</span> clang
cflags <span class="o">=</span> -Weverything

rule compile
  <span class="nb">command</span> <span class="o">=</span> <span class="nv">$cc</span> <span class="nv">$cflags</span> -c <span class="nv">$in</span> -o <span class="nv">$out</span>

rule link
  <span class="nb">command</span> <span class="o">=</span> <span class="nv">$cc</span> <span class="nv">$in</span> -o <span class="nv">$out</span>

build hello.o: compile hello.c
build hello: link hello.o

default hello
</pre> <p>Putting aside the fact that there&rsquo;s no point in writing something like this for a single file, let&rsquo;s see what&rsquo;s going on there. First, we define 2 variables and later refer to them using the <code>$</code> sign. Second, there are rules. Rules are essentially functions that call an external command to perform an action. Finally, build statements are used to define dependencies between input and output files. If you were to write the same with Make using its conventions, you&rsquo;d probably end up with something like <a href="https://gist.github.com/mekishizufu/5f0750989c2cefc0e257">this</a>.</p> <p>To see a more realistic example with proper dependency tracking, I converted <a href="//libgit2.github.com">libgit2</a>&rsquo;s <a href="https://github.com/libgit2/libgit2/blob/2b403/Makefile.embed">Makefile.embed</a> to Ninja. The Makefile compiles libgit2 and creates a static library out of it. You can see the result <a href="https://gist.github.com/mekishizufu/1d099dda373280206aee">here</a>.</p> <p>You&rsquo;ve probably noticed a few things. First, Ninja scripts are explicit. You cannot use any fancy substitution/wildcard functions (or any other control structures for that matter). As a result, the script is not only much longer but it also cannot handle any conditions making it unsuitable to any multi platform/compiler development. And this is by design.</p> <p>I&rsquo;ve mentioned that Ninja is meant to be used with a higher level tool (generator). One of the reasons for doing that is to overcome the said issues. In practice this means that you do not care about the absence of conditions or any other capabilities because the generator handles it for you simply by generating a different set of build scripts.</p> <p>Ninja comes with a simple <a href="https://github.com/martine/ninja/blob/84986/misc/ninja_syntax.py">Python based generator</a>. The generator is straightforward, you call the methods and it outputs the corresponding Ninja syntax to a file. Since it&rsquo;s just Python, you can make all of the platform and compiler decisions here. In fact, this is the way Ninja itself is <a href="https://github.com/martine/ninja/blob/84986/configure.py">built</a>:</p> <pre class="highlight python"><span class="kn">from</span> <span class="nn">ninja_syntax</span> <span class="kn">import</span> <span class="n">Writer</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"build.ninja"</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">buildfile</span><span class="p">:</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">Writer</span><span class="p">(</span><span class="n">buildfile</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">is_msvc</span><span class="p">():</span>
        <span class="n">n</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s">"link"</span><span class="p">,</span>
                <span class="n">command</span><span class="o">=</span><span class="s">"$cxx $in $libs /nologo /link $ldflags /out:$out"</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s">"LINK $out"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s">"link"</span><span class="p">,</span>
                <span class="n">command</span><span class="o">=</span><span class="s">"$cxx $ldflags -o $out $in $libs"</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s">"LINK $out"</span><span class="p">)</span>
</pre> <p>The fun part is that Ninja is already supported by some of the most popular meta build systems out there - <a href="//www.cmake.org">CMake</a> and <a href="https://code.google.com/p/gyp">Gyp</a>. If you have a CMake based project and assuming you have Ninja available in your PATH, all you need to do is to choose Ninja as the <a href="//www.cmake.org/cmake/help/v2.8.12/cmake.html#section_Generators">generator</a>:</p> <pre class="highlight shell"><span class="gp">$ </span><span class="nb">cd </span>libgit2 <span class="o">&amp;&amp;</span> mkdir build <span class="o">&amp;&amp;</span> <span class="nb">cd </span>build
<span class="gp">$ </span>cmake -GNinja ..
<span class="gp">$ </span>ninja
</pre> <p>With this change, CMake generates a bunch of Ninja build files and Ninja builds the project. Notice that there&rsquo;s no need to specify the number of parallel jobs (<code>-j [jobs]</code>) because Ninja automatically chooses the value based on the number of cores available. </p> <p>The compilation speed is not very different although it might be a bit faster due to Ninja consuming very little CPU while driving the build process. What is however very significant are the time savings when working with the source code and invoking the build process again. A non-scientific benchmark performed on my laptop shows that Ninja is indeed much faster:</p> <table class="table table-hover"> <thead> <th></th> <th></th> <th>No file changes</th> <th>1 file change</th> </thead> <tbody> <tr> <td></td> <td><strong>Make</strong></td> <td>0.670s</td> <td>2.404s</td> </tr> <tr> <td></td> <td><strong>Ninja</strong></td> <td>0.041s</td> <td>0.761s</td> </tr> </tbody> </table> <p>These savings will become even more significant as your project grows. I encourage you to try <a href="https://github.com/martine/ninja">Ninja</a> and compare the build cycle times with Make. You will very likely see a similar difference. If you want to learn more about Ninja, here&rsquo;s a few links:</p> <ul> <li><a href="//martine.github.io/ninja">Ninja, a small build system with a focus on speed</a> (homepage)</li> <li><a href="//www.aosabook.org/en/posa/ninja.html">The Performance of Open Source Software | Ninja</a></li> <li><a href="//neugierig.org/software/chromium/notes/2011/02/ninja.html">Ninja, a new build system</a></li> </ul> <div class=twitter-contact><p>If you enjoyed the article, you should follow <a href="https://twitter.com/JiriPospisil">@JiriPospisil</a> on Twitter and subscribe via <a href="/feed.xml">feed</a>.</p></div><div class=visible-xs><hr/><h5>Recent articles</h5><ul><li><a href="/2014/03/16/replacing-make-with-ninja.html">Replacing Make with Ninja</a></li></ul></div><footer><p>&copy; Copyright 2014, Jiří Pospíšil</p></footer></div></div></div><script>window._gaq = window._gaq || [];
window._gaq.push(['_setAccount', 'UA-36750151-1']);
window._gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>